<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Poppy Bowl - Confidence Pool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #2c3e50;
      text-align: center;
    }
    .score-summary {
      background: #e3f2fd;
      padding: 16px;
      border-radius: 6px;
      margin: 20px 0;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    .game {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    .game-info {
      flex: 1;
    }
    .matchup {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .kickoff {
      color: #666;
      font-size: 14px;
    }
    .confidence-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .confidence-input label {
      font-weight: bold;
      color: #2c3e50;
    }
    .confidence-input input {
      width: 60px;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }
    .confidence-input input:focus {
      border-color: #3498db;
      outline: none;
    }
    .actions {
      text-align: center;
      margin-top: 24px;
      gap: 12px;
      display: flex;
      justify-content: center;
    }
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover {
      background: #2980b9;
    }
    .btn.secondary {
      background: #95a5a6;
    }
    .btn.secondary:hover {
      background: #7f8c8d;
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Poppy Bowl Confidence Pool</h1>
    
    <div class="score-summary">
      Total Confidence Score: <span id="total-score">0</span> / <span id="max-score">0</span>
    </div>
    
    <div id="games-container">
      <div class="loading">Loading schedule data...</div>
    </div>
    
    <div class="actions">
      <button id="save-btn" class="btn">Save Selections</button>
      <button id="clear-btn" class="btn secondary">Clear All</button>
    </div>
  </div>

  <script type="module">
    // Types and validation
    interface Game {
      id: string;
      home: string;
      away: string;
      kickoff: string;
    }
    
    interface WeekData {
      week: number;
      games: Game[];
    }
    
    interface ScheduleData {
      season: string;
      weeks: WeekData[];
    }
    
    // Simple runtime validation without Zod dependency
    function validateSchedule(data: any): data is ScheduleData {
      if (!data || typeof data !== 'object') return false;
      if (!data.weeks || !Array.isArray(data.weeks)) return false;
      
      return data.weeks.every((week: any) => {
        return typeof week.week === 'number' &&
               Array.isArray(week.games) &&
               week.games.every((game: any) => 
                 typeof game.id === 'string' &&
                 typeof game.home === 'string' &&
                 typeof game.away === 'string' &&
                 typeof game.kickoff === 'string'
               );
      });
    }
    
    // State management
    let scheduleData: ScheduleData | null = null;
    let confidenceSelections: Record<string, number> = {};
    const STORAGE_KEY = 'poppy-bowl-confidence';
    
    // DOM elements
    const gamesContainer = document.getElementById('games-container')!;
    const totalScoreEl = document.getElementById('total-score')!;
    const maxScoreEl = document.getElementById('max-score')!;
    const saveBtn = document.getElementById('save-btn')!;
    const clearBtn = document.getElementById('clear-btn')!;
    
    // Load saved selections from localStorage
    function loadSavedSelections() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          confidenceSelections = JSON.parse(saved);
        }
      } catch (error) {
        console.warn('Failed to load saved selections:', error);
      }
    }
    
    // Save selections to localStorage
    function saveSelections() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(confidenceSelections));
        alert('Selections saved successfully!');
      } catch (error) {
        console.error('Failed to save selections:', error);
        alert('Failed to save selections. Please try again.');
      }
    }
    
    // Clear all selections
    function clearSelections() {
      if (confirm('Are you sure you want to clear all confidence selections?')) {
        confidenceSelections = {};
        localStorage.removeItem(STORAGE_KEY);
        renderGames();
        updateTotalScore();
      }
    }
    
    // Calculate and update total score display
    function updateTotalScore() {
      const values = Object.values(confidenceSelections);
      const total = values.reduce((sum, val) => sum + val, 0);
      const maxPossible = scheduleData?.weeks[0]?.games.length || 0;
      const maxScore = maxPossible * (maxPossible + 1) / 2; // Sum of 1 to N
      
      totalScoreEl.textContent = total.toString();
      maxScoreEl.textContent = maxScore.toString();
    }
    
    // Handle confidence input changes
    function handleConfidenceChange(gameId: string, value: string) {
      const numValue = parseInt(value);
      const maxGames = scheduleData?.weeks[0]?.games.length || 16;
      
      if (isNaN(numValue) || numValue < 1 || numValue > maxGames) {
        delete confidenceSelections[gameId];
      } else {
        confidenceSelections[gameId] = numValue;
      }
      
      updateTotalScore();
    }
    
    // Render games list
    function renderGames() {
      if (!scheduleData?.weeks[0]) {
        gamesContainer.innerHTML = '<div class="error">No games found for Week 1</div>';
        return;
      }
      
      const week1 = scheduleData.weeks[0];
      const maxConfidence = week1.games.length;
      
      gamesContainer.innerHTML = week1.games.map(game => {
        const currentValue = confidenceSelections[game.id] || '';
        const kickoffDate = new Date(game.kickoff).toLocaleString();
        
        return `
          <div class="game">
            <div class="game-info">
              <div class="matchup">${game.away} @ ${game.home}</div>
              <div class="kickoff">${kickoffDate}</div>
            </div>
            <div class="confidence-input">
              <label>Confidence:</label>
              <input 
                type="number" 
                min="1" 
                max="${maxConfidence}" 
                value="${currentValue}"
                placeholder="1-${maxConfidence}"
                data-game-id="${game.id}"
                class="confidence-input-field"
              >
            </div>
          </div>
        `;
      }).join('');
      
      // Add event listeners to inputs
      const inputs = gamesContainer.querySelectorAll('.confidence-input-field');
      inputs.forEach(input => {
        input.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const gameId = target.dataset.gameId!;
          handleConfidenceChange(gameId, target.value);
        });
      });
      
      updateTotalScore();
    }
    
    // Load schedule data
    async function loadScheduleData() {
      try {
        const response = await fetch('./data/data/schedule-2025.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!validateSchedule(data)) {
          throw new Error('Invalid schedule data format');
        }
        
        scheduleData = data;
        renderGames();
        
      } catch (error) {
        console.error('Failed to load schedule:', error);
        gamesContainer.innerHTML = `
          <div class="error">
            <strong>Failed to load schedule data</strong><br>
            ${error instanceof Error ? error.message : 'Unknown error'}<br>
            <br>
            Please ensure the file <code>data/data/schedule-2025.json</code> exists and is properly formatted.
          </div>
        `;
      }
    }
    
    // Initialize app
    async function init() {
      loadSavedSelections();
      await loadScheduleData();
      
      // Bind event handlers
      saveBtn.addEventListener('click', saveSelections);
      clearBtn.addEventListener('click', clearSelections);
    }
    
    // Start the application
    init();
  </script>
</body>
</html>
