<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Poppy Bowl 2025 - 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./style.css?v=250">
</head>
<body>
  <h1>Poppy Bowl 2025 - 2026</h1>
  <div class="banner" id="currentUserBanner"></div>
  <div class="user-selector" id="userSelector">
    <div style="font-weight:600; margin-bottom: 8px;">Who's submitting picks?</div>
    <div class="controls">
      <label>
        Choose participant:
        <select id="userDropdown" style="margin-left:8px;"></select>
      </label>
      or
      <input id="userCustom" placeholder="Enter name" type="text"/>
      <button id="userSelectBtn">Continue</button>
    </div>
    <div class="small">Tip: use this to switch between participants and enter each person's picks on this device.</div>
  </div>
  <div class="tabs">
    <button class="tab-button active" data-tab="leaderboard">Leaderboard</button>
    <button class="tab-button" data-tab="picks">Picks</button>
    <button class="tab-button" data-tab="scoreboard">Scoreboard</button>
  </div>
  <div class="tab-content" id="leaderboard" style="display:block;">
    <h2>Leaderboard</h2>
    <div class="section">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <div class="tab-content" id="picks">
    <h2>Picks</h2>
    <div class="controls week-controls">
      <button id="prevWeek">Previous Week</button>
      <span>Current: <strong id="currentWeekDisplay">Week 1</strong></span>
      <input type="hidden" id="currentWeekNum" value="1">
      <button id="nextWeek">Next Week</button>
      <button class="sync-btn" id="syncFromGithub">Sync from GitHub</button>
    </div>
    <div class="controls pick-controls">
      <button id="savePicksBtn">Save Picks</button>
      <button id="clearPicksBtn">Clear Picks</button>
      <button id="exportBtn">Export Data</button>
      <button id="importBtn">Import Data</button>
      <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>
    <div id="weeklyPicks"></div>
  </div>
  <div class="tab-content" id="scoreboard" style="display:none;">
    <h2>Scoreboard</h2>
    <div class="controls week-controls">
      <button id="scorePrevWeek">Previous Week</button>
      <span>Current: <strong id="scoreWeekDisplay">Week 1</strong></span>
      <button id="scoreNextWeek">Next Week</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>This Week</th>
          <th>Cumulative Total</th>
        </tr>
      </thead>
      <tbody id="scoreboardBody"></tbody>
    </table>
    <div class="small" id="scoresTimestamp" style="margin-top:10px;"></div>
  </div>
  <!-- Load SaveWinners before AdminBar to ensure it's available -->
<script src="./src/lib/SaveWinners.js"></script>
<script src="./src/components/AdminBar.js"></script>
<script src="./src/lib/PicksStorage.js"></script>
<script src="./src/lib/PicksShim.js"></script>
<script>
(function(){
  const YEAR = 2025;
  const LOCAL_PREFIX = 'poppy:picks:2025:';
  function localKey(user, week) { return `${LOCAL_PREFIX}${week}:${user}`; }

  async function saveUserPicks(user, week, picksObj) {
    if (!user || !week) return false;
    const payload = { picks: picksObj, savedAt: new Date().toISOString() };
    try { localStorage.setItem(localKey(user, week), JSON.stringify(payload)); } catch {}
    try {
      if (window.picksStorage && window.picksStorage.isConfigured()) {
        return await window.picksStorage.savePicksToGitHub(user, YEAR, week, payload);
      }
    } catch (e) { console.warn('GitHub save failed; local-only this time:', e); }
    return true;
  }

  async function loadUserPicks(user, week) {
    if (!user || !week) return {};
    let local = null, remote = null;
    try { const raw = localStorage.getItem(localKey(user, week)); local = raw ? JSON.parse(raw) : null; } catch {}
    try {
      if (window.picksStorage && window.picksStorage.isConfigured()) {
        remote = await window.picksStorage.loadPicksFromGitHub(user, YEAR, week);
      }
    } catch (e) { console.warn('GitHub load failed:', e); }
    const merged = (window.picksStorage && typeof window.picksStorage.mergeLocalAndRemote === 'function')
      ? window.picksStorage.mergeLocalAndRemote(local, remote)
      : (remote || local);
    return merged?.picks || {};
  }

  window.saveUserPicks = saveUserPicks;
  window.loadUserPicks = loadUserPicks;
})();
</script>
<script type="module"<script> (function(){ // 1) Core shim: defines save/load globally so the UI can call them const YEAR = 2025; const LOCAL_PREFIX = 'poppy:picks:2025:'; const key = (user, week) => `${LOCAL_PREFIX}${week}:${user}`; async function saveUserPicks(user, week, picksObj) { if (!user || !week) { console.warn('Missing user/week'); return false; } const payload = { picks: picksObj, savedAt: new Date().toISOString() }; try { localStorage.setItem(key(user, week), JSON.stringify(payload)); } catch(e){} try { if (window.picksStorage && window.picksStorage.isConfigured()) { return await window.picksStorage.savePicksToGitHub(user, YEAR, week, payload); } } catch(e) { console.warn('GitHub save failed; local only', e); } return true; } async function loadUserPicks(user, week) { if (!user || !week) return {}; let local = null, remote = null; try { const raw = localStorage.getItem(key(user, week)); local = raw ? JSON.parse(raw) : null; } catch(e){} try { if (window.picksStorage && window.picksStorage.isConfigured()) { remote = await window.picksStorage.loadPicksFromGitHub(user, YEAR, week); } } catch(e) { console.warn('GitHub load failed', e); } const merged = (window.picksStorage && typeof window.picksStorage.mergeLocalAndRemote === 'function') ? window.picksStorage.mergeLocalAndRemote(local, remote) : (remote || local); return merged?.picks || {}; } window.saveUserPicks = saveUserPicks; window.loadUserPicks = loadUserPicks; // 2) Minimal wiring safeguard: make the Save button call the shim function getCurrentUser() { // Try banner first, then inputs const banner = document.querySelector('#currentUserBanner')?.textContent || ''; const m = banner.match(/Current user:\s*(.+)$/i); if (m && m) return m.trim(); const custom = document.querySelector('#userCustom')?.value?.trim(); if (custom) return custom; const dd = document.querySelector('#userDropdown'); if (dd && dd.value) return dd.value.trim(); return ''; } function getCurrentWeek() { return (document.querySelector('#currentWeekNum')?.value || '1').toString(); } function collectPicksFromUI() { // Fallback collector: looks for rows rendered under #weeklyPicks // Assumes each game row has data-game-id and selected .team + .confidence const picks = {}; const rows = document.querySelectorAll('#weeklyPicks [data-game-id]'); if (!rows.length) { // if UI uses a different structure, try named inputs: const inputs = document.querySelectorAll('#weeklyPicks input, #weeklyPicks select'); if (!inputs.length) return picks; } rows.forEach(row => { const gid = row.getAttribute('data-game-id'); if (!gid) return; const team = row.querySelector('[data-selected-team], .selected-team, .team.selected, select.team')?.value || row.querySelector('.team.selected')?.textContent?.trim() || row.querySelector('[name^="team-"]:checked')?.value || ''; const confStr = (row.querySelector('[name^="conf-"]')?.value || row.querySelector('.confidence')?.value || row.querySelector('.confidence input')?.value || '').toString(); const confidence = parseInt(confStr, 10) || null; if (team || confidence) picks[gid] = { team, confidence }; }); return picks; } function restorePicksToUI(picks) { // Non-destructive best effort: sets values back if matching elements exist if (!picks || typeof picks !== 'object') return; Object.entries(picks).forEach(([gid, val]) => { const row = document.querySelector(`#weeklyPicks [data-game-id="${gid}"]`); if (!row) return; // Try to set team const teamInput = row.querySelector('[data-selected-team], select.team, [name^="team-"]'); if (teamInput) { if (teamInput.tagName === 'SELECT') teamInput.value = val.team || ''; else if ('value' in teamInput) teamInput.value = val.team || ''; } // Try to set confidence const confInput = row.querySelector('[name^="conf-"], .confidence, .confidence input'); if (confInput) { const target = confInput.tagName === 'INPUT' ? confInput : (confInput.querySelector('input') || confInput); if (target && 'value' in target) target.value = (val.confidence ?? '').toString(); } }); } function attachSaveHandler() { const btns = Array.from(document.querySelectorAll('#savePicksBtn')); if (!btns.length) return; // Prefer the last button (often the visible one in your UI) const btn = btns[btns.length - 1]; btn.addEventListener('click', async (e) => { try { const user = getCurrentUser(); const week = getCurrentWeek(); if (!user) { alert('Please select or enter a participant name first.'); return; } const picks = collectPicksFromUI(); const ok = await window.saveUserPicks(user, week, picks); if (!ok) { alert('Unable to save picks.'); return; } // Immediate verify load const loaded = await window.loadUserPicks(user, week); restorePicksToUI(loaded); // Show a simple success console.log('Picks saved for', user, 'week', week); alert('Picks saved.'); } catch (err) { console.error('Save failed', err); alert('Save failed. See console for details.'); } }, { once: false }); } // Attach when DOM is ready if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', attachSaveHandler); } else { attachSaveHandler(); } })(); </script>
<script> (function(){ function getCurrentUser() { const banner = document.querySelector('#currentUserBanner')?.textContent || ''; const m = banner.match(/Current user:\s*(.+)$/i); if (m && m) return m.trim(); const custom = document.querySelector('#userCustom')?.value?.trim(); if (custom) return custom; const dd = document.querySelector('#userDropdown'); if (dd && dd.value) return dd.value.trim(); return ''; } function getCurrentWeek() { return (document.querySelector('#currentWeekNum')?.value || '1').toString(); } function restorePicksToUI(picks) { if (!picks || typeof picks !== 'object') return; Object.entries(picks).forEach(([gid, val]) => { const row = document.querySelector(`#weeklyPicks [data-game-id="${gid}"]`); if (!row) return; const teamInput = row.querySelector('[data-selected-team], select.team, [name^="team-"]'); if (teamInput) { if (teamInput.tagName === 'SELECT') teamInput.value = val.team || ''; else if ('value' in teamInput) teamInput.value = val.team || ''; } const confInput = row.querySelector('[name^="conf-"], .confidence, .confidence input'); if (confInput) { const target = confInput.tagName === 'INPUT' ? confInput : (confInput.querySelector('input') || confInput); if (target && 'value' in target) target.value = (val.confidence ?? '').toString(); } }); } async function loadAndRenderCurrentUserWeek() { try { const user = getCurrentUser(); const week = getCurrentWeek(); if (!user) return; const picks = await window.loadUserPicks(user, week); restorePicksToUI(picks); console.log('Loaded picks for', user, 'week', week, picks); } catch (e) { console.warn('Load on user change failed:', e); } } function attachUserChangeHandlers() { const dd = document.querySelector('#userDropdown'); if (dd) dd.addEventListener('change', loadAndRenderCurrentUserWeek); const custom = document.querySelector('#userCustom'); const btn = document.querySelector('#userSelectBtn'); if (btn) btn.addEventListener('click', loadAndRenderCurrentUserWeek); // Also respond to week navigation const prev = document.querySelector('#prevWeek'); const next = document.querySelector('#nextWeek'); if (prev) prev.addEventListener('click', () => setTimeout(loadAndRenderCurrentUserWeek, 0)); if (next) next.addEventListener('click', () => setTimeout(loadAndRenderCurrentUserWeek, 0)); // And initial load when Picks tab first shows document.addEventListener('DOMContentLoaded', () => { setTimeout(loadAndRenderCurrentUserWeek, 0); }); } if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', attachUserChangeHandlers); } else { attachUserChangeHandlers(); } })(); </script>
src="./src/main.js"></script>













